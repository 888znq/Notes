<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinity Notes</title>
    
    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#0F1419">
    <meta name="mobile-web-app-capable" content="yes">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Infinity Notes">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --row-height: 90px; 
            --num-width: 65px; 
            --font-main: 1.7rem;
            --line-weight: 1.5px;
            --bg-dark: #0F1419;
            --bg-secondary: #1A1F29;
            --accent: #00D9FF;
            --accent-dim: rgba(0, 217, 255, 0.1);
            --line-style: var(--line-weight) solid var(--accent);
            --deck-height: 220px;
            --text-muted: #6B7280;
            --border-radius: 4px;
            --active-category-color: #00D9FF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            overscroll-behavior-y: none; 
            user-select: none;
            border-left: var(--line-weight) solid var(--active-category-color);
        }

        .app-frame {
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--deck-height));
            width: 100%;
            border-left: var(--line-weight) solid var(--active-category-color);
            border-right: var(--line-weight) solid var(--active-category-color);
            position: relative;
            counter-reset: note-counter;
        }

        #notes-list {
            display: flex;
            flex-direction: column; 
            justify-content: flex-end; 
            width: 100%;
            overflow-y: auto;
            flex-grow: 1;
            -webkit-mask-image: linear-gradient(to top, black 85%, transparent 100%);
            mask-image: linear-gradient(to top, black 85%, transparent 100%);
        }

        .grid-row {
            display: grid;
            grid-template-columns: var(--num-width) 1fr;
            width: 100%;
            height: var(--row-height);
            flex-shrink: 0;
            background-color: var(--bg-dark);
            border-top: var(--line-style);
        }

        .grid-row.hidden { display: none !important; }

        .spacer-line {
            height: 100%;
            background-color: var(--bg-secondary);
            border-right: var(--line-weight) solid var(--active-category-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            color: var(--active-category-color);
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            position: relative;
        }

        .spacer-line.number {
            flex-direction: column;
            gap: 8px;
        }

        .spacer-line.number::after {
            counter-increment: note-counter;
            content: counter(note-counter);
            font-size: 0.95rem;
            color: var(--accent);
            opacity: 1;
            font-weight: 600;
            order: 2;
        }

        .spacer-line.infinity::after { 
            content: "∞"; 
            font-size: 1.8rem;
            color: var(--active-category-color);
            opacity: 0.8;
        }

        .content-wrapper {
            position: relative;
            overflow: hidden;
            background-color: var(--accent);
            height: 100%;
            display: flex;
        }

        .note-content {
            width: 100%;
            height: 100%;
            background-color: var(--bg-dark);
            color: var(--accent);
            border: none;
            padding: 16px 20px 0 16px; 
            font-size: var(--font-main);
            font-weight: 600;
            outline: none;
            display: flex;
            align-items: center;
            caret-color: var(--accent);
            white-space: nowrap;
            overflow: hidden;
            transition: transform 0.25s cubic-bezier(0.2, 0, 0.2, 1);
            position: relative;
            z-index: 2;
            user-select: text;
            letter-spacing: 0.3px;
        }

        /* --- INPUT AREA --- */
        .input-area {
            border-top-color: var(--active-category-color) !important;
            border-left-color: var(--active-category-color) !important;
            border-right-color: var(--active-category-color) !important;
        }

        #cat-input {
            width: 90px;
            height: 100%;
            background-color: var(--bg-secondary);
            color: var(--active-category-color);
            border: none;
            border-right: var(--line-weight) solid var(--active-category-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            padding: 0 5px;
            outline: none;
            z-index: 5;
            user-select: text;
            letter-spacing: 1.2px;
        }
        #cat-input::placeholder { color: var(--text-muted); }

        .note-cat-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            text-transform: uppercase;
            opacity: 1;
            letter-spacing: 1.2px;
            pointer-events: none;
            z-index: 8;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            padding: 6px 8px;
            border: 1.5px solid;
            border-radius: 3px;
            white-space: nowrap;
            order: 1;
        }

        /* Category-specific colors for note rows when displayed */
        .note-row[data-category="WORK"] { --cat-color: #FF1744; }
        .note-row[data-category="TODO"] { --cat-color: #00E5FF; }
        .note-row[data-category="IDEA"] { --cat-color: #FFEA00; }
        .note-row[data-category="WOW"] { --cat-color: #D500F9; }
        .note-row[data-category="WFGWG"] { --cat-color: #FF6E40; }
        .note-row[data-category="SRF"] { --cat-color: #00E676; }
        .note-row[data-category="RRRR"] { --cat-color: #FF4081; }
        .note-row[data-category="TTT"] { --cat-color: #00B0FF; }
        .note-row[data-category="FD"] { --cat-color: #FF3D00; }
        .note-row[data-category="FWERFFFF"] { --cat-color: #B388FF; }
        .note-row[data-category="GEN"] { --cat-color: #00BCD4; }

        /* Apply category color to border top */
        .note-row[data-category="WORK"] { border-top-color: #FF1744 !important; }
        .note-row[data-category="TODO"] { border-top-color: #00E5FF !important; }
        .note-row[data-category="IDEA"] { border-top-color: #FFEA00 !important; }
        .note-row[data-category="WOW"] { border-top-color: #D500F9 !important; }
        .note-row[data-category="WFGWG"] { border-top-color: #FF6E40 !important; }
        .note-row[data-category="SRF"] { border-top-color: #00E676 !important; }
        .note-row[data-category="RRRR"] { border-top-color: #FF4081 !important; }
        .note-row[data-category="TTT"] { border-top-color: #00B0FF !important; }
        .note-row[data-category="FD"] { border-top-color: #FF3D00 !important; }
        .note-row[data-category="FWERFFFF"] { border-top-color: #B388FF !important; }
        .note-row[data-category="GEN"] { border-top-color: #00BCD4 !important; }

        /* Number color */
        .note-row[data-category="WORK"] .spacer-line.number::after { color: #FF1744; }
        .note-row[data-category="TODO"] .spacer-line.number::after { color: #00E5FF; }
        .note-row[data-category="IDEA"] .spacer-line.number::after { color: #FFEA00; }
        .note-row[data-category="WOW"] .spacer-line.number::after { color: #D500F9; }
        .note-row[data-category="WFGWG"] .spacer-line.number::after { color: #FF6E40; }
        .note-row[data-category="SRF"] .spacer-line.number::after { color: #00E676; }
        .note-row[data-category="RRRR"] .spacer-line.number::after { color: #FF4081; }
        .note-row[data-category="TTT"] .spacer-line.number::after { color: #00B0FF; }
        .note-row[data-category="FD"] .spacer-line.number::after { color: #FF3D00; }
        .note-row[data-category="FWERFFFF"] .spacer-line.number::after { color: #B388FF; }
        .note-row[data-category="GEN"] .spacer-line.number::after { color: #00BCD4; }

        /* Content text color and caret */
        .note-row[data-category="WORK"] .note-content { color: #FF1744; caret-color: #FF1744; }
        .note-row[data-category="TODO"] .note-content { color: #00E5FF; caret-color: #00E5FF; }
        .note-row[data-category="IDEA"] .note-content { color: #FFEA00; caret-color: #FFEA00; }
        .note-row[data-category="WOW"] .note-content { color: #D500F9; caret-color: #D500F9; }
        .note-row[data-category="WFGWG"] .note-content { color: #FF6E40; caret-color: #FF6E40; }
        .note-row[data-category="SRF"] .note-content { color: #00E676; caret-color: #00E676; }
        .note-row[data-category="RRRR"] .note-content { color: #FF4081; caret-color: #FF4081; }
        .note-row[data-category="TTT"] .note-content { color: #00B0FF; caret-color: #00B0FF; }
        .note-row[data-category="FD"] .note-content { color: #FF3D00; caret-color: #FF3D00; }
        .note-row[data-category="FWERFFFF"] .note-content { color: #B388FF; caret-color: #B388FF; }
        .note-row[data-category="GEN"] .note-content { color: #00BCD4; caret-color: #00BCD4; }

        /* Category input color */
        .note-row[data-category="WORK"] .note-cat-input { color: #FF1744; border-right-color: #FF1744; }
        .note-row[data-category="TODO"] .note-cat-input { color: #00E5FF; border-right-color: #00E5FF; }
        .note-row[data-category="IDEA"] .note-cat-input { color: #FFEA00; border-right-color: #FFEA00; }
        .note-row[data-category="WOW"] .note-cat-input { color: #D500F9; border-right-color: #D500F9; }
        .note-row[data-category="WFGWG"] .note-cat-input { color: #FF6E40; border-right-color: #FF6E40; }
        .note-row[data-category="SRF"] .note-cat-input { color: #00E676; border-right-color: #00E676; }
        .note-row[data-category="RRRR"] .note-cat-input { color: #FF4081; border-right-color: #FF4081; }
        .note-row[data-category="TTT"] .note-cat-input { color: #00B0FF; border-right-color: #00B0FF; }
        .note-row[data-category="FD"] .note-cat-input { color: #FF3D00; border-right-color: #FF3D00; }
        .note-row[data-category="FWERFFFF"] .note-cat-input { color: #B388FF; border-right-color: #B388FF; }
        .note-row[data-category="GEN"] .note-cat-input { color: #00BCD4; border-right-color: #00BCD4; }

        /* Spacer line border color by category */
        .note-row[data-category="WORK"] .spacer-line { border-right-color: #FF1744; }
        .note-row[data-category="TODO"] .spacer-line { border-right-color: #00E5FF; }
        .note-row[data-category="IDEA"] .spacer-line { border-right-color: #FFEA00; }
        .note-row[data-category="WOW"] .spacer-line { border-right-color: #D500F9; }
        .note-row[data-category="WFGWG"] .spacer-line { border-right-color: #FF6E40; }
        .note-row[data-category="SRF"] .spacer-line { border-right-color: #00E676; }
        .note-row[data-category="RRRR"] .spacer-line { border-right-color: #FF4081; }
        .note-row[data-category="TTT"] .spacer-line { border-right-color: #00B0FF; }
        .note-row[data-category="FD"] .spacer-line { border-right-color: #FF3D00; }
        .note-row[data-category="FWERFFFF"] .spacer-line { border-right-color: #B388FF; }
        .note-row[data-category="GEN"] .spacer-line { border-right-color: #00BCD4; }

        /* Content wrapper border */
        .note-row[data-category="WORK"] .content-wrapper { border-left-color: #FF1744; }
        .note-row[data-category="TODO"] .content-wrapper { border-left-color: #00E5FF; }
        .note-row[data-category="IDEA"] .content-wrapper { border-left-color: #FFEA00; }
        .note-row[data-category="WOW"] .content-wrapper { border-left-color: #D500F9; }
        .note-row[data-category="WFGWG"] .content-wrapper { border-left-color: #FF6E40; }
        .note-row[data-category="SRF"] .content-wrapper { border-left-color: #00E676; }
        .note-row[data-category="RRRR"] .content-wrapper { border-left-color: #FF4081; }
        .note-row[data-category="TTT"] .content-wrapper { border-left-color: #00B0FF; }
        .note-row[data-category="FD"] .content-wrapper { border-left-color: #FF3D00; }
        .note-row[data-category="FWERFFFF"] .content-wrapper { border-left-color: #B388FF; }
        .note-row[data-category="GEN"] .content-wrapper { border-left-color: #00BCD4; }

        /* --- NOTE CATEGORY INPUT --- */
        .note-cat-input {
            width: 90px;
            height: 100%;
            background-color: var(--bg-secondary);
            color: var(--accent);
            border: none;
            border-right: var(--line-style);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            padding: 0 5px;
            outline: none;
            z-index: 5;
            user-select: text;
            letter-spacing: 1.2px;
            cursor: default;
        }

        /* Category-specific border colors */
        .note-row[data-category="WORK"] .note-cat-label { border-color: #FF1744; color: #FF1744; }
        .note-row[data-category="TODO"] .note-cat-label { border-color: #00E5FF; color: #00E5FF; }
        .note-row[data-category="IDEA"] .note-cat-label { border-color: #FFEA00; color: #FFEA00; }
        .note-row[data-category="WOW"] .note-cat-label { border-color: #D500F9; color: #D500F9; }
        .note-row[data-category="WFGWG"] .note-cat-label { border-color: #FF6E40; color: #FF6E40; }
        .note-row[data-category="SRF"] .note-cat-label { border-color: #00E676; color: #00E676; }
        .note-row[data-category="RRRR"] .note-cat-label { border-color: #FF4081; color: #FF4081; }
        .note-row[data-category="TTT"] .note-cat-label { border-color: #00B0FF; color: #00B0FF; }
        .note-row[data-category="FD"] .note-cat-label { border-color: #FF3D00; color: #FF3D00; }
        .note-row[data-category="FWERFFFF"] .note-cat-label { border-color: #B388FF; color: #B388FF; }
        .note-row[data-category="GEN"] .note-cat-label { border-color: #00BCD4; color: #00BCD4; }

        /* Default color for any other category */
        .note-row .note-cat-label { border-color: var(--accent); color: var(--accent); }

        /* --- CATEGORY DECK --- */
        #category-deck {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--deck-height);
            background-color: var(--bg-secondary);
            border-top: var(--line-weight) solid var(--active-category-color);
            border-left: var(--line-weight) solid var(--active-category-color);
            border-right: var(--line-weight) solid var(--active-category-color);
            border-bottom: var(--line-weight) solid var(--active-category-color);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 16px 20px 20px 20px;
        }

        .deck-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 12px;
            opacity: 1;
            text-align: center;
            letter-spacing: 2px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        #deck-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            overflow-y: auto;
            justify-content: center;
            align-content: flex-start;
            height: 100%;
            padding-bottom: 10px;
        }

        .deck-btn {
            background-color: transparent;
            border: var(--line-weight) solid var(--accent);
            color: var(--accent);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            padding: 12px 16px;
            cursor: pointer;
            flex-grow: 1;
            min-width: 90px;
            max-width: 45%;
            text-align: center;
            transition: all 0.2s cubic-bezier(0.2, 0, 0.2, 1);
            letter-spacing: 0.8px;
            border-radius: var(--border-radius);
        }

        /* Category-specific button colors */
        .deck-btn[data-category="WORK"] { border-color: #FF1744; color: #FF1744; }
        .deck-btn[data-category="TODO"] { border-color: #00E5FF; color: #00E5FF; }
        .deck-btn[data-category="IDEA"] { border-color: #FFEA00; color: #FFEA00; }
        .deck-btn[data-category="WOW"] { border-color: #D500F9; color: #D500F9; }
        .deck-btn[data-category="WFGWG"] { border-color: #FF6E40; color: #FF6E40; }
        .deck-btn[data-category="SRF"] { border-color: #00E676; color: #00E676; }
        .deck-btn[data-category="RRRR"] { border-color: #FF4081; color: #FF4081; }
        .deck-btn[data-category="TTT"] { border-color: #00B0FF; color: #00B0FF; }
        .deck-btn[data-category="FD"] { border-color: #FF3D00; color: #FF3D00; }
        .deck-btn[data-category="FWERFFFF"] { border-color: #B388FF; color: #B388FF; }
        .deck-btn[data-category="GEN"] { border-color: #00BCD4; color: #00BCD4; }

        .deck-btn:active { transform: scale(0.95); }

        /* Active button states */
        .deck-btn[data-category="WORK"].active { background-color: #FF1744; color: var(--bg-dark); }
        .deck-btn[data-category="TODO"].active { background-color: #00E5FF; color: var(--bg-dark); }
        .deck-btn[data-category="IDEA"].active { background-color: #FFEA00; color: #0F1419; }
        .deck-btn[data-category="WOW"].active { background-color: #D500F9; color: var(--bg-dark); }
        .deck-btn[data-category="WFGWG"].active { background-color: #FF6E40; color: #0F1419; }
        .deck-btn[data-category="SRF"].active { background-color: #00E676; color: var(--bg-dark); }
        .deck-btn[data-category="RRRR"].active { background-color: #FF4081; color: var(--bg-dark); }
        .deck-btn[data-category="TTT"].active { background-color: #00B0FF; color: #0F1419; }
        .deck-btn[data-category="FD"].active { background-color: #FF3D00; color: var(--bg-dark); }
        .deck-btn[data-category="FWERFFFF"].active { background-color: #B388FF; color: var(--bg-dark); }
        .deck-btn[data-category="GEN"].active { background-color: #00BCD4; color: var(--bg-dark); }

        /* --- UTILITY --- */
        .delete-hint {
            position: absolute;
            right: 25px;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            color: var(--bg-dark);
            font-size: 0.85rem;
            font-weight: 700;
            z-index: 1;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            letter-spacing: 0.5px;
        }

        .desktop-delete-btn {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 65px;
            background-color: var(--bg-dark);
            color: var(--accent);
            border: none;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            opacity: 0; 
            transition: opacity 0.2s;
            font-weight: 300;
        }

        .content-wrapper:hover .desktop-delete-btn { opacity: 1; }
        .desktop-delete-btn:hover { background-color: var(--accent); color: var(--bg-dark); }
        
        @media (hover: none) {
            .desktop-delete-btn { display: none; }
        }

        #notes-list::-webkit-scrollbar { display: none; }
        #deck-grid::-webkit-scrollbar { display: none; }
        #main-input { padding-top: 0; font-size: 1.85rem; font-weight: 700; color: var(--active-category-color); caret-color: var(--active-category-color); } 
    </style>
</head>
<body>

    <div class="app-frame">
        <div id="notes-list"></div>

        <div class="input-area grid-row">
            <div class="spacer-line infinity"></div>
            <div class="content-wrapper">
                <input id="cat-input" list="cat-suggestions" placeholder="CAT" autocomplete="off">
                <datalist id="cat-suggestions"></datalist>
                <div id="main-input" class="note-content" contenteditable="true" spellcheck="false"></div>
            </div>
        </div>
    </div>

    <div id="category-deck">
        <div class="deck-label">SYSTEM_CATEGORIES (HOLD_TO_WIPE)</div>
        <div id="deck-grid"></div>
    </div>

<script>
    const notesList = document.getElementById('notes-list');
    const mainInput = document.getElementById('main-input');
    const catInput = document.getElementById('cat-input');
    const catDataList = document.getElementById('cat-suggestions');
    const deckGrid = document.getElementById('deck-grid');

    let savedCategories = new Set();
    let currentFilter = '';
    let customCategoryColors = {};

    function loadCustomColors() {
        const stored = localStorage.getItem('infinity_custom_colors');
        if (stored) {
            customCategoryColors = JSON.parse(stored);
        }
    }

    function saveCustomColors() {
        localStorage.setItem('infinity_custom_colors', JSON.stringify(customCategoryColors));
    }

    function generateColorForCategory(category) {
        // Generate a consistent color based on category name
        let hash = 0;
        for (let i = 0; i < category.length; i++) {
            hash = category.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        // Generate vibrant colors
        const hue = Math.abs(hash % 360);
        const saturation = 85 + (Math.abs(hash) % 15); // 85-100%
        const lightness = 50 + (Math.abs(hash >> 8) % 15); // 50-65%
        
        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    function getCategoryColor(category) {
        const predefinedColors = {
            'WORK': '#FF1744',
            'TODO': '#00E5FF',
            'IDEA': '#FFEA00',
            'WOW': '#D500F9',
            'WFGWG': '#FF6E40',
            'SRF': '#00E676',
            'RRRR': '#FF4081',
            'TTT': '#00B0FF',
            'FD': '#FF3D00',
            'FWERFFFF': '#B388FF',
            'GEN': '#00BCD4'
        };
        
        if (predefinedColors[category]) {
            return predefinedColors[category];
        }
        
        if (!customCategoryColors[category]) {
            customCategoryColors[category] = generateColorForCategory(category);
            saveCustomColors();
        }
        
        return customCategoryColors[category];
    }

    function applyCategoryStyles(category) {
        const color = getCategoryColor(category);
        
        // Create dynamic style element if it doesn't exist
        let styleEl = document.getElementById('dynamic-category-styles');
        if (!styleEl) {
            styleEl = document.createElement('style');
            styleEl.id = 'dynamic-category-styles';
            document.head.appendChild(styleEl);
        }
        
        // Add CSS rules for this category
        const css = `
            .note-row[data-category="${category}"] { border-top-color: ${color} !important; }
            .note-row[data-category="${category}"] .spacer-line.number::after { color: ${color}; }
            .note-row[data-category="${category}"] .note-content { color: ${color}; caret-color: ${color}; }
            .note-row[data-category="${category}"] .note-cat-input { color: ${color}; border-right-color: ${color}; }
            .note-row[data-category="${category}"] .spacer-line { border-right-color: ${color}; }
            .note-row[data-category="${category}"] .note-cat-label { border-color: ${color}; color: ${color}; }
            .deck-btn[data-category="${category}"] { border-color: ${color}; color: ${color}; }
            .deck-btn[data-category="${category}"].active { background-color: ${color}; color: var(--bg-dark); }
        `;
        
        // Check if this category already has styles
        if (!styleEl.textContent.includes(`[data-category="${category}"]`)) {
            styleEl.textContent += css;
        }
    } 

    function renderDeck() {
        deckGrid.innerHTML = '';
        savedCategories.forEach(cat => {
            applyCategoryStyles(cat); // Apply styles for this category
            
            const btn = document.createElement('button');
            btn.className = `deck-btn ${currentFilter === cat ? 'active' : ''}`;
            btn.innerText = cat;
            btn.setAttribute('data-category', cat);
            
            let pressTimer;
            let isLongPress = false;

            const startPress = () => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    if(confirm(`Wipe category '${cat}'? Notes will move to 'GEN'.`)) {
                        deleteCategory(cat);
                    }
                }, 800); 
            };

            const cancelPress = () => clearTimeout(pressTimer);

            btn.addEventListener('touchstart', (e) => {
                startPress();
            }, {passive: true});
            btn.addEventListener('touchend', (e) => {
                cancelPress();
                if (!isLongPress) applyFilter(cat); 
            }, {passive: true});
            btn.addEventListener('touchmove', (e) => {
                cancelPress();
            }, {passive: true}); 

            btn.addEventListener('mousedown', startPress);
            btn.addEventListener('mouseup', () => {
                cancelPress();
                if (!isLongPress) applyFilter(cat); 
            });
            btn.addEventListener('mouseleave', cancelPress);

            deckGrid.appendChild(btn);
        });
    }

    function deleteCategory(categoryToDelete) {
        if (categoryToDelete === 'GEN') {
            alert("Cannot delete System 'GEN'.");
            return;
        }
        const notesRaw = localStorage.getItem('infinity_notes_v2');
        if (notesRaw) {
            let notes = JSON.parse(notesRaw);
            notes.forEach(n => { if (n.category === categoryToDelete) n.category = "GEN"; });
            localStorage.setItem('infinity_notes_v2', JSON.stringify(notes));
        }
        savedCategories.delete(categoryToDelete);
        saveCategories();
        if (currentFilter === categoryToDelete) {
            applyFilter(savedCategories.values().next().value || 'GEN');
        } else {
            if (!savedCategories.has(currentFilter)) currentFilter = 'GEN';
            loadAll(); 
        }
    }

    function updateCategorySuggestions() {
        catDataList.innerHTML = '';
        savedCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            catDataList.appendChild(option);
        });
        renderDeck(); 
    }

    function saveCategories() {
        localStorage.setItem('infinity_categories', JSON.stringify([...savedCategories]));
    }

    function loadCategories() {
        const storedCats = localStorage.getItem('infinity_categories');
        if (storedCats) {
            savedCategories = new Set(JSON.parse(storedCats));
        } else {
            savedCategories.add("WORK");
            savedCategories.add("TODO");
            savedCategories.add("IDEA");
            savedCategories.add("GEN");
        }
        updateCategorySuggestions();
    }

    function applyFilter(category) {
        currentFilter = category;
        renderDeck(); 
        catInput.value = category;
        
        const color = getCategoryColor(category);
        document.documentElement.style.setProperty('--active-category-color', color);

        const rows = document.querySelectorAll('#notes-list .note-row');
        rows.forEach(row => {
            if (row.dataset.category === category) row.classList.remove('hidden');
            else row.classList.add('hidden');
        });
        setTimeout(() => { notesList.scrollTop = notesList.scrollHeight; }, 10);
    }

    function saveAll() {
        const notes = [];
        document.querySelectorAll('#notes-list .note-row').forEach(row => {
            notes.push({ 
                text: row.querySelector('.note-content').innerText, 
                category: row.dataset.category || "GEN" 
            });
        });
        localStorage.setItem('infinity_notes_v2', JSON.stringify(notes));
    }

    function loadAll() {
        loadCategories();
        const rawData = localStorage.getItem('infinity_notes_v2');
        if (rawData) {
            const notes = JSON.parse(rawData);
            notesList.innerHTML = ''; 
            notes.forEach(note => {
                notesList.appendChild(createNoteRow(note.text, note.category));
                if(note.category) savedCategories.add(note.category);
            });
            saveCategories();
            updateCategorySuggestions();
            if (!currentFilter || !savedCategories.has(currentFilter)) {
                currentFilter = savedCategories.values().next().value || "GEN";
            }
            applyFilter(currentFilter);
        } else {
            currentFilter = savedCategories.values().next().value || "GEN";
            applyFilter(currentFilter);
        }
    }

    function handleEnter(e, sourceElement, type) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const text = sourceElement.innerText.trim();
            if (type === 'main' && text !== "") {
                let category = catInput.value.trim().toUpperCase();
                if (!category) category = "GEN";
                if (!savedCategories.has(category)) {
                    savedCategories.add(category);
                    saveCategories();
                    updateCategorySuggestions();
                    applyFilter(category);
                }
                const newRow = createNoteRow(text, category);
                notesList.appendChild(newRow);
                if (currentFilter !== category) newRow.classList.add('hidden');
                sourceElement.innerText = ""; 
                catInput.value = currentFilter;
                saveAll();
                setTimeout(() => { notesList.scrollTop = notesList.scrollHeight; }, 10);
            } else if (type === 'insert') {
                const insertedRow = createNoteRow("", currentFilter);
                sourceElement.closest('.grid-row').insertAdjacentElement('afterend', insertedRow);
                insertedRow.querySelector('.note-content').focus();
                saveAll();
            }
        }
    }

    catInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); mainInput.focus(); }});
    mainInput.addEventListener('keydown', (e) => handleEnter(e, mainInput, 'main'));

    function createNoteRow(text, category) {
        const row = document.createElement('div');
        row.className = 'note-row grid-row';
        row.dataset.category = category;
        row.innerHTML = `
            <div class="spacer-line number"></div>
            <div class="content-wrapper">
                <input class="note-cat-input" type="text" readonly value="${category}">
                <div class="delete-hint">DELETE</div>
                <div class="note-content" contenteditable="true" spellcheck="false">${text}</div>
                <button class="desktop-delete-btn" tabindex="-1">×</button>
            </div>
        `;
        const content = row.querySelector('.note-content');
        row.querySelector('.desktop-delete-btn').addEventListener('click', () => { row.remove(); saveAll(); });
        content.addEventListener('keyup', saveAll);
        content.addEventListener('keydown', (e) => handleEnter(e, content, 'insert'));

        let startX = 0;
        content.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; content.style.transition = 'none'; }, { passive: true });
        content.addEventListener('touchmove', (e) => {
            let diff = e.touches[0].clientX - startX;
            if (diff < -20) content.style.transform = `translateX(${diff + 20}px)`;
        }, { passive: true });
        content.addEventListener('touchend', (e) => {
            let finalDiff = e.changedTouches[0].clientX - startX;
            content.style.transition = 'transform 0.4s cubic-bezier(0.1, 0.9, 0.2, 1)';
            if (finalDiff < -180) {
                content.style.transform = 'translateX(-100%)';
                setTimeout(() => { row.remove(); saveAll(); }, 300);
            } else { content.style.transform = 'translateX(0)'; }
        });
        return row;
    }

    document.addEventListener('touchstart', (e) => {
        if (e.target.closest('#category-deck')) return;
        if (!e.target.classList.contains('note-content') && e.target.id !== 'cat-input') {
            e.preventDefault(); mainInput.focus();
        }
    });
    
    window.addEventListener('load', () => { loadCustomColors(); loadAll(); catInput.focus(); });
</script>
</body>
</html>
