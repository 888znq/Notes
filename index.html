<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinity Notes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root { --row-height: 90px; --num-width: 65px; --font-main: 1.7rem; --line-weight: 1.5px; --bg-dark: #0F1419; --bg-secondary: #1A1F29; --accent: #00D9FF; --line-style: var(--line-weight) solid var(--accent); --deck-height: 220px; --text-muted: #6B7280; --border-radius: 4px; --active-category-color: #00D9FF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-dark); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Inter', sans-serif; overflow: hidden; overscroll-behavior-y: none; user-select: none; border-left: var(--line-weight) solid var(--active-category-color); }
        .app-frame { display: flex; flex-direction: column; height: calc(100vh - var(--deck-height)); width: 100%; border-right: var(--line-weight) solid var(--active-category-color); position: relative; counter-reset: note-counter; }
        #notes-list { display: flex; flex-direction: column; justify-content: flex-end; width: 100%; overflow-y: auto; flex-grow: 1; -webkit-mask-image: linear-gradient(to top, black 85%, transparent 100%); mask-image: linear-gradient(to top, black 85%, transparent 100%); }
        .grid-row { display: grid; grid-template-columns: var(--num-width) 1fr; width: 100%; height: var(--row-height); flex-shrink: 0; background-color: var(--bg-dark); border-top: var(--line-style); }
        .grid-row.hidden { display: none !important; }
        .spacer-line { height: 100%; background-color: var(--bg-secondary); border-right: var(--line-weight) solid var(--active-category-color); display: flex; align-items: center; justify-content: center; z-index: 10; color: var(--active-category-color); font-weight: 700; font-family: 'JetBrains Mono', monospace; position: relative; }
        .spacer-line.number { flex-direction: column; gap: 8px; }
        .spacer-line.number::after { counter-increment: note-counter; content: counter(note-counter); font-size: 0.95rem; color: var(--accent); opacity: 1; font-weight: 600; order: 2; }
        .spacer-line.infinity::after { content: "∞"; font-size: 1.8rem; color: var(--active-category-color); opacity: 0.8; }
        .content-wrapper { position: relative; overflow: hidden; background-color: var(--accent); height: 100%; display: flex; }
        .note-content { width: 100%; height: 100%; background-color: var(--bg-dark); color: var(--accent); border: none; padding: 16px 20px 0 16px; font-size: var(--font-main); font-weight: 600; outline: none; display: flex; align-items: center; caret-color: var(--accent); white-space: nowrap; overflow: hidden; transition: transform 0.25s; position: relative; z-index: 2; user-select: text; letter-spacing: 0.3px; }
        .input-area { border-top-color: var(--active-category-color) !important; }
        #cat-input { width: 90px; height: 100%; background-color: var(--bg-secondary); color: var(--active-category-color); border: none; border-right: var(--line-weight) solid var(--active-category-color); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; text-align: center; padding: 0 5px; outline: none; z-index: 5; user-select: text; letter-spacing: 1.2px; }
        .note-cat-label { display: inline-flex; align-items: center; justify-content: center; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1.2px; pointer-events: none; z-index: 8; font-weight: 700; font-family: 'JetBrains Mono', monospace; padding: 6px 8px; border: 1.5px solid; border-radius: 3px; white-space: nowrap; order: 1; }
        .note-cat-input { width: 90px; height: 100%; background-color: var(--bg-secondary); color: var(--accent); border: none; border-right: var(--line-style); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; text-align: center; padding: 0 5px; outline: none; z-index: 5; user-select: text; letter-spacing: 1.2px; cursor: default; }
        #category-deck { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--deck-height); background-color: var(--bg-secondary); border: var(--line-weight) solid var(--active-category-color); z-index: 100; display: flex; flex-direction: column; padding: 16px 20px 20px 20px; }
        .deck-label { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; text-align: center; letter-spacing: 2px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        #deck-grid { display: flex; flex-wrap: wrap; gap: 10px; overflow-y: auto; justify-content: center; align-content: flex-start; height: 100%; padding-bottom: 10px; }
        .deck-btn { background-color: transparent; border: var(--line-weight) solid var(--accent); color: var(--accent); font-family: 'Inter', sans-serif; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; padding: 12px 16px; cursor: pointer; flex-grow: 1; min-width: 90px; max-width: 45%; text-align: center; transition: all 0.2s; letter-spacing: 0.8px; border-radius: var(--border-radius); }
        .deck-btn.active { background-color: var(--accent); color: var(--bg-dark); }
        .delete-hint { position: absolute; right: 25px; top: 0; bottom: 0; display: flex; align-items: center; color: var(--bg-dark); font-size: 0.85rem; font-weight: 700; z-index: 1; font-family: 'Inter', sans-serif; letter-spacing: 0.5px; }
        .desktop-delete-btn { position: absolute; right: 0; top: 0; bottom: 0; width: 65px; background-color: var(--bg-dark); color: var(--accent); border: none; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; opacity: 0; transition: opacity 0.2s; }
        .content-wrapper:hover .desktop-delete-btn { opacity: 1; }
        @media (hover: none) { .desktop-delete-btn { display: none; } }
        #notes-list::-webkit-scrollbar { display: none; } #deck-grid::-webkit-scrollbar { display: none; }
        #main-input { padding-top: 0; font-size: 1.85rem; font-weight: 700; color: var(--active-category-color); caret-color: var(--active-category-color); }
        #status-log { position: fixed; top: 10px; left: 10px; color: #333; font-size: 10px; font-family: monospace; z-index: 200; pointer-events: none;}
    </style>
</head>
<body>

    <div id="status-log">Connecting...</div>
    <div class="app-frame">
        <div id="notes-list"></div>
        <div class="input-area grid-row">
            <div class="spacer-line infinity"></div>
            <div class="content-wrapper">
                <input id="cat-input" list="cat-suggestions" placeholder="CAT" autocomplete="off">
                <datalist id="cat-suggestions"></datalist>
                <div id="main-input" class="note-content" contenteditable="true" spellcheck="false"></div>
            </div>
        </div>
    </div>

    <div id="category-deck">
        <div class="deck-label">SYSTEM_CATEGORIES (HOLD_TO_WIPE)</div>
        <div id="deck-grid"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // YOUR CONFIG IS EMBEDDED HERE
        const firebaseConfig = {
            apiKey: "AIzaSyAYHA8Qw3Qzbyg8MtjrSKcJusNi4VaA6V4",
            authDomain: "system-data-bf026.firebaseapp.com",
            databaseURL: "https://system-data-bf026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "system-data-bf026",
            storageBucket: "system-data-bf026.firebasestorage.app",
            messagingSenderId: "718302899022",
            appId: "1:718302899022:web:f1675dbcc293e138c68c1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'infinity_notes_data'); // Unique folder for App 2

        // --- LOGIC ---
        const notesList = document.getElementById('notes-list');
        const mainInput = document.getElementById('main-input');
        const catInput = document.getElementById('cat-input');
        const catDataList = document.getElementById('cat-suggestions');
        const deckGrid = document.getElementById('deck-grid');
        const statusLog = document.getElementById('status-log');

        let savedCategories = new Set(["WORK", "TODO", "IDEA", "GEN"]);
        let currentFilter = 'GEN';
        let customCategoryColors = {};
        let allNotes = [];

        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                if(data.notes) allNotes = data.notes; else allNotes = [];
                if(data.categories) savedCategories = new Set(data.categories);
                if(data.colors) customCategoryColors = data.colors;
                renderAll();
                statusLog.innerText = "LIVE"; statusLog.style.color = "#00D9FF";
            } else { renderAll(); }
        });

        function pushToFirebase() {
            set(dbRef, { notes: allNotes, categories: [...savedCategories], colors: customCategoryColors });
        }

        function generateColorForCategory(category) {
            let hash = 0;
            for (let i = 0; i < category.length; i++) hash = category.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, ${85 + (Math.abs(hash) % 15)}%, ${50 + (Math.abs(hash >> 8) % 15)}%)`;
        }

        function getCategoryColor(category) {
            const defaults = { 'WORK':'#FF1744', 'TODO':'#00E5FF', 'IDEA':'#FFEA00', 'GEN':'#00BCD4' };
            if (defaults[category]) return defaults[category];
            if (!customCategoryColors[category]) {
                customCategoryColors[category] = generateColorForCategory(category);
                pushToFirebase();
            }
            return customCategoryColors[category];
        }

        function applyCategoryStyles(category) {
            const color = getCategoryColor(category);
            let styleEl = document.getElementById('dyn-style-'+category);
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dyn-style-'+category;
                document.head.appendChild(styleEl);
            }
            styleEl.textContent = `
                .note-row[data-category="${category}"] { border-top-color: ${color} !important; }
                .note-row[data-category="${category}"] .spacer-line.number::after,
                .note-row[data-category="${category}"] .note-content,
                .note-row[data-category="${category}"] .note-cat-input,
                .deck-btn[data-category="${category}"] { color: ${color}; }
                .deck-btn[data-category="${category}"] { border-color: ${color}; }
                .deck-btn[data-category="${category}"].active { background-color: ${color}; color: #000; }
                .note-row[data-category="${category}"] .spacer-line { border-right-color: ${color}; }
            `;
        }

        function renderAll() {
            notesList.innerHTML = '';
            catDataList.innerHTML = '';
            deckGrid.innerHTML = '';
            
            savedCategories.forEach(cat => {
                applyCategoryStyles(cat);
                const opt = document.createElement('option'); opt.value = cat; catDataList.appendChild(opt);
                const btn = document.createElement('button');
                btn.className = `deck-btn ${currentFilter === cat ? 'active' : ''}`;
                btn.innerText = cat;
                btn.dataset.category = cat;
                btn.onclick = () => { applyFilter(cat); };
                
                let timer;
                const start = () => timer = setTimeout(() => {
                    if(cat!=='GEN' && confirm(`Delete ${cat}?`)) {
                        allNotes.forEach(n => { if(n.category===cat) n.category='GEN'; });
                        savedCategories.delete(cat);
                        currentFilter='GEN';
                        pushToFirebase();
                    }
                }, 800);
                const end = () => clearTimeout(timer);
                btn.onmousedown = btn.ontouchstart = start;
                btn.onmouseup = btn.ontouchend = end;
                deckGrid.appendChild(btn);
            });

            allNotes.forEach(note => {
                const row = createNoteRow(note.text, note.category);
                notesList.appendChild(row);
                if(currentFilter && note.category !== currentFilter) row.classList.add('hidden');
            });

            if(!savedCategories.has(currentFilter)) currentFilter = 'GEN';
            const color = getCategoryColor(currentFilter);
            document.documentElement.style.setProperty('--active-category-color', color);
            catInput.value = currentFilter;
        }

        function applyFilter(cat) {
            currentFilter = cat;
            renderAll();
            setTimeout(() => { notesList.scrollTop = notesList.scrollHeight; }, 10);
        }

        function createNoteRow(text, category) {
            const row = document.createElement('div');
            row.className = 'note-row grid-row';
            row.dataset.category = category;
            row.innerHTML = `
                <div class="spacer-line number"></div>
                <div class="content-wrapper">
                    <input class="note-cat-input" type="text" readonly value="${category}">
                    <div class="delete-hint">DELETE</div>
                    <div class="note-content" contenteditable="true" spellcheck="false">${text}</div>
                    <button class="desktop-delete-btn">×</button>
                </div>`;
            
            const content = row.querySelector('.note-content');
            
            const updateNote = () => {
                const idx = Array.from(notesList.children).indexOf(row);
                if(idx > -1) { allNotes[idx].text = content.innerText; pushToFirebase(); }
            };
            content.onkeyup = updateNote;

            row.querySelector('.desktop-delete-btn').onclick = () => {
                const idx = Array.from(notesList.children).indexOf(row);
                if(idx > -1) { allNotes.splice(idx, 1); pushToFirebase(); }
            };

            let startX = 0;
            content.ontouchstart = (e) => startX = e.touches[0].clientX;
            content.ontouchmove = (e) => {
                let diff = e.touches[0].clientX - startX;
                if(diff < -20) content.style.transform = `translateX(${diff+20}px)`;
            };
            content.ontouchend = (e) => {
                let diff = e.changedTouches[0].clientX - startX;
                content.style.transition = 'transform 0.3s';
                if(diff < -150) {
                     content.style.transform = 'translateX(-100%)';
                     setTimeout(() => row.querySelector('.desktop-delete-btn').click(), 300);
                } else { content.style.transform = 'translateX(0)'; }
            };
            return row;
        }

        mainInput.onkeydown = (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                const txt = mainInput.innerText.trim();
                if(txt) {
                    let cat = catInput.value.trim().toUpperCase() || "GEN";
                    if(!savedCategories.has(cat)) { savedCategories.add(cat); }
                    allNotes.push({ text: txt, category: cat });
                    currentFilter = cat;
                    mainInput.innerText = "";
                    pushToFirebase();
                }
            }
        };
        catInput.onkeydown = (e) => { if(e.key==='Enter') { e.preventDefault(); mainInput.focus(); }};
    </script>
</body>
</html>
